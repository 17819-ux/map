<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8" />
<title>Flood Check ‚Äî 3D MAP</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<link href="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.css" rel="stylesheet" />
<style>
html,body{height:100%;margin:0;padding:0;font-family:system-ui,Segoe UI,Roboto,Arial;}
#map{position:absolute;inset:0}
.panel{
  position:absolute;left:12px;top:12px;z-index:10;
  background:rgba(255,255,255,0.95);padding:12px;border-radius:10px;
  box-shadow:0 8px 20px rgba(0,0,0,0.12);width:380px;
}
.row{display:flex;gap:8px;align-items:center;margin:8px 0;flex-wrap:wrap}
input[type="text"]{flex:1;padding:8px;border:1px solid #ddd;border-radius:8px}
button{padding:8px 10px;border-radius:8px;border:0;background:#0b63d6;color:#fff;cursor:pointer}
button.secondary{background:#e8eaed;color:#111}
select, input[type="range"]{padding:7px;border:1px solid #ddd;border-radius:8px}
.status{font-size:13px;color:#333;margin-top:6px;}
small.muted{display:block;color:#666;margin-top:6px}
.legend{display:flex;gap:12px;align-items:center;margin-top:8px;font-size:12px;color:#333}
.legend .box{width:14px;height:14px;border-radius:3px;border:1px solid #999}
.flex-1{flex:1}
.label{font-size:12px;color:#333}
.val{min-width:38px;text-align:right;font-variant-numeric:tabular-nums}
</style>
</head>
<body>
<div id="map"></div>

<div class="panel">
  <div style="font-weight:800;margin-bottom:6px">üó∫Ô∏è Flood Check</div>

  <div class="row">
    <label style="min-width:110px">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà</label>
    <input id="search" type="text" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏≠‡∏∏‡∏ö‡∏•‡∏£‡∏≤‡∏ä‡∏ò‡∏≤‡∏ô‡∏µ, ‡∏ö‡∏≤‡∏á‡∏ö‡∏±‡∏ß‡∏ó‡∏≠‡∏á" />
    <button id="btnSearch">üîç</button>
  </div>

  <div class="row">
    <button id="btnLocate" class="secondary">üìç ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô</button>
    <button id="btnTilt">‚õ∞ ‡∏™‡∏•‡∏±‡∏ö‡πÄ‡∏≠‡∏µ‡∏¢‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà</button>
    <div class="flex-1"></div>
    <label class="label">‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô:</label>
    <select id="basemap">
      <option value="osm" selected>‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà</option>
      <option value="sat">‡∏î‡∏≤‡∏ß‡πÄ‡∏ó‡∏µ‡∏¢‡∏°</option>
    </select>
  </div>

  <div class="row">
    <label class="label" style="min-width:110px">‡∏ô‡∏π‡∏ô‡∏†‡∏π‡∏°‡∏¥‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®</label>
    <input id="exaggeration" type="range" min="1" max="3" step="0.1" value="1.3" class="flex-1"/>
    <div class="val"><span id="exVal">1.3</span>x</div>
  </div>

  <div class="status" id="status">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</div>

  <div class="legend">
    <div class="box" style="background:#7cc8ff;border-color:#1E90FF"></div> ‡∏ô‡πâ‡∏≥/‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ô‡πâ‡∏≥‡∏ñ‡∏≤‡∏ß‡∏£
    <div class="box" style="background:#00aaff"></div> ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡πÅ‡∏ó‡πá‡∏Å‡∏ß‡πà‡∏≤ ‚Äú‡∏ô‡πâ‡∏≥‡∏ó‡πà‡∏ß‡∏°/‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ô‡πâ‡∏≥‡∏ó‡πà‡∏ß‡∏°‚Äù
  </div>

  <small class="muted">W/A/S/D = ‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ó‡∏µ‡πà (‡∏ï‡∏≤‡∏°‡∏°‡∏∏‡∏°‡∏Å‡∏•‡πâ‡∏≠‡∏á), Arrow = ‡∏´‡∏°‡∏∏‡∏ô/‡πÄ‡∏≠‡∏µ‡∏¢‡∏á, Tilt = ‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÄ‡∏≠‡∏µ‡∏¢‡∏á 3D</small>
</div>

<script src="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.js"></script>
<script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>
<script>
/* ====== Map Init with 3D Terrain & Sky ====== */
const INITIAL_EXAGG = 1.3;

const map = new maplibregl.Map({
  container:'map',
  style:{
    version:8,
    sources:{
      'osm-tiles':{
        type:'raster',
        tiles:[
          'https://a.tile.openstreetmap.org/{z}/{x}/{y}.png',
          'https://b.tile.openstreetmap.org/{z}/{x}/{y}.png',
          'https://c.tile.openstreetmap.org/{z}/{x}/{y}.png'
        ],
        tileSize:256,
        attribution:'¬© OpenStreetMap contributors'
      },
      'satellite-tiles':{
        type:'raster',
        tiles:[
          'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}'
        ],
        tileSize:256,
        attribution:'Imagery ¬© Esri, Maxar, Earthstar Geographics'
      },
      // DEM ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Terrain 3D (‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏à‡∏≤‡∏Å MapLibre)
      'terrain-dem':{
        type:'raster-dem',
        url:'https://demotiles.maplibre.org/terrain-tiles/tiles.json',
        tileSize:256
      }
    },
    layers:[
      { id:'osm-tiles', type:'raster', source:'osm-tiles' },
      { id:'satellite-tiles', type:'raster', source:'satellite-tiles', layout:{ visibility:'none' } },
      // ‡∏ä‡∏±‡πâ‡∏ô‡∏ó‡πâ‡∏≠‡∏á‡∏ü‡πâ‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏°‡∏à‡∏£‡∏¥‡∏á
      {
        id:'sky',
        type:'sky',
        paint:{
          'sky-type':'atmosphere',
          'sky-atmosphere-sun':[0.0, 0.0],
          'sky-atmosphere-sun-intensity':10
        }
      }
    ],
    terrain:{ source:'terrain-dem', exaggeration: INITIAL_EXAGG }
  },
  center:[100.5018,13.7563],
  zoom:12,
  pitch:55,
  bearing:15,
  attributionControl:true,
  antialias:true
});

/* ====== UI Elements ====== */
const btnSearch=document.getElementById('btnSearch');
const searchInput=document.getElementById('search');
const btnLocate=document.getElementById('btnLocate');
const btnTilt=document.getElementById('btnTilt');
const statusEl=document.getElementById('status');
const baseSelect=document.getElementById('basemap');
const exRange=document.getElementById('exaggeration');
const exVal=document.getElementById('exVal');
let tilted=true;

function setStatus(txt,severity='info'){
  statusEl.textContent='‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: '+txt;
  statusEl.style.color = (severity==='warn') ? '#b22222' : (severity==='ok' ? '#137333' : '#222');
}

/* ====== Search (Nominatim) + Flood Loader (Overpass) ====== */
async function searchLocation(query){
  try{
    setStatus('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà...');
    const response=await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`);
    const data=await response.json();
    if(data.length===0) throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤');
    const {lat, lon}=data[0];
    map.easeTo({center:[+lon, +lat], zoom:14});
    await loadFloodAround(+lat, +lon);
  }catch(e){
    setStatus('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ: '+e.message,'warn');
  }
}

function buildOverpassFloodQuery(lat,lon,r=5000){
  return `
    [out:json][timeout:25];
    (
      way(around:${r},${lat},${lon})["natural"="water"];
      relation(around:${r},${lat},${lon})["natural"="water"];
      way(around:${r},${lat},${lon})["waterway"="riverbank"];
      relation(around:${r},${lat},${lon})["waterway"="riverbank"];
      way(around:${r},${lat},${lon})["hazard"="flood"];
      relation(around:${r},${lat},${lon})["hazard"="flood"];
      way(around:${r},${lat},${lon})["flood_prone"="yes"];
      relation(around:${r},${lat},${lon})["flood_prone"="yes"];
      way(around:${r},${lat},${lon})["floodplain"="yes"];
      relation(around:${r},${lat},${lon})["floodplain"="yes"];
      way(around:${r},${lat},${lon})["flooded"="yes"];
      relation(around:${r},${lat},${lon})["flooded"="yes"];
    );
    out body geom;
  `.trim();
}

function elementsToFeatures(elements){
  const features=[];
  for(const el of elements){
    if(el.type!=='way' || !el.geometry || el.geometry.length<3) continue;
    const coords=el.geometry.map(p=>[p.lon,p.lat]);
    const first=coords[0], last=coords[coords.length-1];
    if(first[0]!==last[0] || first[1]!==last[1]) coords.push([first[0],first[1]]);
    const tags=el.tags||{};
    const isFlood = (tags.hazard==='flood') || (tags.flood_prone==='yes') || (tags.floodplain==='yes') || (tags.flooded==='yes') || (tags['flood:prone']==='yes');
    features.push({ type:'Feature', geometry:{type:'Polygon',coordinates:[coords]}, properties:{...tags,__isFloodHazard:!!isFlood,__sourceId:el.id} });
  }
  return features;
}

async function loadFloodAround(lat,lon){
  try{
    setStatus('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡πâ‡∏≥/‡∏ô‡πâ‡∏≥‡∏ó‡πà‡∏ß‡∏° (OSM/Overpass)...');
    const overpassUrl='https://overpass-api.de/api/interpreter';
    const q=buildOverpassFloodQuery(lat,lon,5000);
    const r=await fetch(overpassUrl,{
      method:'POST',
      headers:{'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8'},
      body:'data='+encodeURIComponent(q)
    });
    const d=await r.json();
    const features=elementsToFeatures(d.elements||[]);
    const floodCount=features.filter(f=>f.properties.__isFloodHazard).length;
    const waterCount=features.length - floodCount;
    const geojson={type:'FeatureCollection',features};

    // ‡∏•‡πâ‡∏≤‡∏á‡πÄ‡∏î‡∏¥‡∏°‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏ï‡∏¥‡∏°‡πÉ‡∏´‡∏°‡πà
    ['flood-fill','flood-line'].forEach(id=>{ if(map.getLayer(id)) map.removeLayer(id); });
    if(map.getSource('flood-geojson')) map.removeSource('flood-geojson');

    map.addSource('flood-geojson',{type:'geojson',data:geojson});
    map.addLayer({
      id:'flood-fill', type:'fill', source:'flood-geojson',
      paint:{
        'fill-color':[
          'case',['boolean',['get','__isFloodHazard'],false],'#00aaff','#7cc8ff'
        ],
        'fill-opacity':[
          'case',['boolean',['get','__isFloodHazard'],false],0.55,0.30
        ]
      }
    });
    map.addLayer({
      id:'flood-line', type:'line', source:'flood-geojson',
      paint:{
        'line-color':['case',['boolean',['get','__isFloodHazard'],false],'#0088cc','#1E90FF'],
        'line-width':2
      }
    });

    if(features.length>0){
      setStatus(`‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ‡∏ô‡πâ‡∏≥‡∏ó‡πà‡∏ß‡∏°/‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á ${floodCount} ‡πÇ‡∏û‡∏•‡∏¥‡∏Å‡∏≠‡∏ô ‚Ä¢ ‡∏ô‡πâ‡∏≥/‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ô‡πâ‡∏≥ ${waterCount} ‡πÇ‡∏û‡∏•‡∏¥‡∏Å‡∏≠‡∏ô`,'ok');
    }else{
      setStatus('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡πâ‡∏≥/‡∏ô‡πâ‡∏≥‡∏ó‡πà‡∏ß‡∏°‡πÉ‡∏ô‡∏£‡∏±‡∏®‡∏°‡∏µ 5 ‡∏Å‡∏°.','warn');
    }
  }catch(e){
    setStatus('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ: '+e.message,'warn');
  }
}

/* ====== Base Toggle & Terrain Exaggeration ====== */
function setBasemap(which){
  const osm = (which==='osm');
  map.setLayoutProperty('osm-tiles','visibility', osm ? 'visible' : 'none');
  map.setLayoutProperty('satellite-tiles','visibility', osm ? 'none' : 'visible');
}
baseSelect.addEventListener('change', e => setBasemap(e.target.value));

exRange.addEventListener('input', e=>{
  const v=parseFloat(e.target.value);
  exVal.textContent=v.toFixed(1);
  map.setTerrain({ source:'terrain-dem', exaggeration:v });
});

/* ====== Tilt Toggle ====== */
function toggleTilt(){
  tilted=!tilted;
  map.easeTo({ pitch: tilted?60:0, bearing: tilted?map.getBearing():0, duration:800 });
}
btnTilt.addEventListener('click',toggleTilt);

/* ====== Camera-relative Movement (WASD) ====== */
function moveByBearing(deltaDeg, meters){
  const c = map.getCenter();
  const b = map.getBearing() + deltaDeg;
  const km = meters / 1000;
  const p = turf.destination([c.lng,c.lat], km, b, {units:'kilometers'}).geometry.coordinates;
  map.easeTo({center:[p[0],p[1]], duration:150});
}
function stepMeters(){
  // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏£‡∏∞‡∏¢‡∏∞‡∏ï‡∏≤‡∏°‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ã‡∏π‡∏° (‡∏ã‡∏π‡∏°‡πÄ‡∏Ç‡πâ‡∏≤ = ‡∏Å‡πâ‡∏≤‡∏ß‡∏™‡∏±‡πâ‡∏ô‡∏•‡∏á)
  const z = map.getZoom();
  const m = 50 * Math.pow(2, (14 - z));
  return Math.min(800, Math.max(15, m));
}
document.addEventListener('keydown',e=>{
  const m = stepMeters();
  const rot=5, pitchStep=5;
  switch(e.key){
    case 'w': case 'W': moveByBearing(0,   m); break;
    case 's': case 'S': moveByBearing(180, m); break;
    case 'a': case 'A': moveByBearing(-90, m); break;
    case 'd': case 'D': moveByBearing(90,  m); break;
    case 'ArrowUp':   map.easeTo({pitch: map.getPitch()+pitchStep}); break;
    case 'ArrowDown': map.easeTo({pitch: Math.max(0, map.getPitch()-pitchStep)}); break;
    case 'ArrowLeft': map.easeTo({bearing: map.getBearing()-rot}); break;
    case 'ArrowRight':map.easeTo({bearing: map.getBearing()+rot}); break;
  }
});

/* ====== Search & Locate ====== */
btnSearch.addEventListener('click',()=>{
  const q=searchInput.value.trim();
  if(q) searchLocation(q);
});
searchInput.addEventListener('keydown',e=>{
  if(e.key==='Enter'){
    const q=searchInput.value.trim();
    if(q) searchLocation(q);
  }
});
btnLocate.addEventListener('click',()=>{
  if(!navigator.geolocation){alert('‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö Geolocation');return;}
  navigator.geolocation.getCurrentPosition(async pos=>{
    const {latitude,longitude}=pos.coords;
    map.easeTo({center:[longitude,latitude],zoom:14});
    await loadFloodAround(latitude,longitude);
  },err=>{alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á: '+err.message);});
});

/* ====== On Load ====== */
map.on('load',()=>{
  setBasemap('osm'); // ‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô = ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà
  exVal.textContent = INITIAL_EXAGG.toFixed(1);
  setStatus('‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô ‚Äî ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà ‡πÅ‡∏•‡πâ‡∏ß‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ô‡πâ‡∏≥/‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡πÅ‡∏ó‡πá‡∏Å‡∏ß‡πà‡∏≤ ‚Äú‡∏ô‡πâ‡∏≥‡∏ó‡πà‡∏ß‡∏°/‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ô‡πâ‡∏≥‡∏ó‡πà‡∏ß‡∏°‚Äù ‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡∏ü‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏°');
  // ‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏≤‡∏Å‡πÉ‡∏´‡πâ‡πÇ‡∏´‡∏•‡∏î‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏ö‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥:
  // loadFloodAround(13.7563,100.5018);
});
</script>
</body>
</html>
